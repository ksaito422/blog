<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>GoogleCloud on ksaito.dev</title>
    <link>//localhost:1313/tags/googlecloud/</link>
    <description>Recent content in GoogleCloud on ksaito.dev</description>
    <generator>Hugo -- 0.146.6</generator>
    <language>ja-jp</language>
    <lastBuildDate>Sun, 12 Nov 2023 16:57:00 +0900</lastBuildDate>
    <atom:link href="//localhost:1313/tags/googlecloud/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>CloudLoadBalancingでバックエンドバケットにルーティングするときはpathとバケット内の階層を一致させよう</title>
      <link>//localhost:1313/posts/2023-11-12/</link>
      <pubDate>Sun, 12 Nov 2023 16:57:00 +0900</pubDate>
      <guid>//localhost:1313/posts/2023-11-12/</guid>
      <description>&lt;p&gt;GoogleCloudLoadBalancing（以下、GCLB）のurl-mapを指定して、バックエンドバケットにルーティングするときに地味にハマったエラーとその解消法について書きます。&lt;/p&gt;
&lt;h3 id=&#34;環境&#34;&gt;環境&lt;/h3&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;GoogleCloud

# terraformで構築するため一応バージョンのせておく
terraform --version
  v1.3.5
hashicorp/google
  v4.74.0
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;結論&#34;&gt;結論&lt;/h3&gt;
&lt;p&gt;GCLBを経由してGCSのオブジェクト参照するときは、オブジェクトのpathとurl-mapで指定するpathは一致させる必要があります。&lt;/p&gt;
&lt;h3 id=&#34;解説&#34;&gt;解説&lt;/h3&gt;
&lt;p&gt;今回使用するterraformのコードの一部です。他にもgcsなどのリソースも作ってますが、解説する内容とは関係ないので省略してます。&lt;/p&gt;
&lt;p&gt;デフォルトのルートとは別に&lt;code&gt;paths = [&amp;quot;/test/*&amp;quot;]&lt;/code&gt;でバックエンドバケットにルーティングするように設定されています。&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;resource &amp;#34;google_compute_url_map&amp;#34; &amp;#34;default&amp;#34; {
  name = &amp;#34;${local.project}-${local.prefix}&amp;#34;

  default_service = google_compute_backend_bucket.backend_bucket.id

  host_rule {
    hosts        = [&amp;#34;*&amp;#34;]
    path_matcher = &amp;#34;path-matcher-2&amp;#34;
  }
  path_matcher {
    name            = &amp;#34;path-matcher-2&amp;#34;
    default_service = google_compute_backend_bucket.backend_bucket.id

    path_rule {
      paths   = [&amp;#34;/test/*&amp;#34;]
      service = google_compute_backend_bucket.backend_bucket.id
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;上記のコードで構築した、GCLBの設定は以下のようになっています。&lt;/p&gt;
&lt;p&gt;そして、対象のバックエンドバケットには以下のようにオブジェクトが配置されています。&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;training-394392-gclb-cdn-gcs
├── hengao_mabuta_uragaesu.png
└── test
      └── buranko_boy_smile.png
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;では、環境構築できたのでGCLB経由してオブジェクトを参照してみます。&lt;/p&gt;
&lt;p&gt;NGなURLでは、NoSuchKeyとエラーになり、OKなURLではブラウザなどで画像参照ができます。&lt;/p&gt;
&lt;p&gt;それぞれNGとOKな理由は恐らく以下の通りだと思います。（あくまでも、個人の見解なので理由は違うかもしれないです）&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;NGなURL
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;http://34.36.243.201/test/hengao_mabuta_uragaesu.png&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;test以下に対象のファイル名はないためエラーになる&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;http://34.36.243.201/test/test/buranko_boy_smile.png&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;test/testという階層がバケットには作られていないためエラーになる&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;OKなURL
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;http://34.36.243.201/test/buranko_boy_smile.png&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;test階層の下に対象のファイル名が存在するため画像参照できる&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ちなみになんか画像参照できないなってときはAuditLogを有効にすると、CloudLoggingにGCSの操作ログが流れてくるので、&lt;code&gt;storage.objects.get&lt;/code&gt;しているログを見つけて、参照pathを確認するとデバッグが捗るようになると思います！&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
